{% extends "paginas/modelo.html" %}

{% block conteudo %}
<div class="card mt-4">
    <div class="card-body">
        <div class="mb-2">
            <a href="{% url 'index' %}" class="btn btn-secondary btn-sm me-2" id="voltarBtn"
               onclick="if(document.referrer){ history.back(); return false; }">← Voltar</a>
        </div>
        <h2 class="card-title">{{ object.titulo }}</h2>
        <p class="text-muted">Por {{ object.autor }} — {{ object.data|date:"d/m/Y H:i" }} — Categoria: {{ object.categoria }}</p>
        <p class="card-text">{{ object.texto }}</p>
        <p>
            {% if media_avaliacao %}
                <strong>Média:</strong> {{ media_avaliacao }} / 5
            {% else %}
                <em>Nenhuma avaliação ainda.</em>
            {% endif %}
        </p>
        {% if user.is_authenticated %}
            {% if user.is_superuser or user == object.autor %}
                <div class="mt-2">
                    <a href="{% url 'post_editar' object.pk %}" class="btn btn-sm btn-warning">Editar</a>
                    <form action="{% url 'post_excluir' object.pk %}" method="post" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Confirma exclusão deste post?');">Excluir</button>
                    </form>
                </div>
            {% endif %}
        {% endif %}
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <h4>Comentários</h4>
        {% if comentarios %}
            <ul class="list-group">
                {% for c in comentarios %}
                    <li class="list-group-item d-flex justify-content-between align-items-start">
                        <div>
                            <strong>{{ c.autor }}</strong> <small class="text-muted">— {{ c.data|date:"d/m/Y H:i" }}</small>
                            <div>{{ c.comentario }}</div>
                        </div>
                        <div>
                            {% if user.is_authenticated %}
                                {% if user.is_superuser or user == c.autor %}
                                    <a href="{% url 'comentario_editar' c.pk %}" class="btn btn-sm btn-warning me-1">Editar</a>
                                    <form action="{% url 'comentario_excluir' c.pk %}" method="post" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Confirma exclusão deste comentário?');">Excluir</button>
                                    </form>
                                {% endif %}
                            {% endif %}
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>Nenhum comentário ainda.</p>
        {% endif %}

        {% if user.is_authenticated %}
            <form action="{% url 'post_comentar' object.pk %}" method="post" class="mt-3" id="comentarioForm">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="comentario" class="form-label">Seu comentário</label>
                    <textarea name="comentario" id="comentario" rows="3" class="form-control" maxlength="5000"></textarea>
                    <div class="form-text"><span id="charCount">0</span>/5000 caracteres</div>
                </div>
                <button class="btn btn-primary" id="comentarioSubmit">Publicar Comentário</button>
            </form>
        {% else %}
            <p><a href="{% url 'login' %}?next={% url 'post_detail' object.pk %}">Faça login</a> para comentar.</p>
        {% endif %}
    </div>

    <div class="col-md-6">
        <h4>Avaliações</h4>
        {% if avaliacoes %}
            <ul class="list-group">
                {% for a in avaliacoes %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>{{ a.autor }} — Nota: {{ a.nota }}</div>
                        <div>
                            {% if user.is_authenticated %}
                                {% if user.is_superuser or user == a.autor %}
                                    <a href="{% url 'avaliacao_editar' a.pk %}" class="btn btn-sm btn-warning me-1">Editar</a>
                                    <form action="{% url 'avaliacao_excluir' a.pk %}" method="post" style="display:inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Confirma exclusão desta avaliação?');">Excluir</button>
                                    </form>
                                {% endif %}
                            {% endif %}
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>Nenhuma avaliação ainda.</p>
        {% endif %}

        {% if user.is_authenticated %}
            <form action="{% url 'post_avaliar' object.pk %}" method="post" class="mt-3">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="nota" class="form-label">Sua nota (1-5)</label>
                    <select name="nota" id="nota" class="form-select">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
                <button class="btn btn-primary">Enviar Avaliação</button>
            </form>
        {% else %}
            <p><a href="{% url 'login' %}?next={% url 'post_detail' object.pk %}">Faça login</a> para avaliar.</p>
        {% endif %}
    </div>
</div>

{% endblock conteudo %}

{% block extra_scripts %}
<script>
    (function(){
        const textarea = document.getElementById('comentario');
        if (!textarea) return;
        const countEl = document.getElementById('charCount');
        const submitBtn = document.getElementById('comentarioSubmit');
        const MAX = 5000;
        function update(){
            const len = textarea.value.length;
            countEl.textContent = len;
            if (len === 0) {
                // disable submit when empty
                submitBtn.disabled = true;
            } else if (len > MAX) {
                submitBtn.disabled = true;
                countEl.style.color = 'red';
            } else {
                submitBtn.disabled = false;
                countEl.style.color = '';
            }
        }
        textarea.addEventListener('input', update);
        // initial
        update();
        // prevent submission if only spaces
        const form = document.getElementById('comentarioForm');
        form.addEventListener('submit', function(e){
            if (textarea.value.trim().length === 0) {
                e.preventDefault();
                alert('Comentário vazio não pode ser criado.');
            }
        });
    })();
</script>
{% endblock extra_scripts %}
